{"version":3,"sources":["../src/PDFJSController.js"],"names":[],"mappings":";AACA,YAAY,CAAC;;;;;;AACb,MAAM,CAAC,KAAK,GAAG,MAAM,CAAC,KAAK,IAAI,EAAE;;;AAAC,AAGlC,OAAO,CAAC,kCAAkC,CAAC,CAAC;AAC5C,OAAO,CAAC,iCAAiC,CAAC,CAAC;AAC3C,OAAO,CAAC,uBAAuB,CAAC,CAAC;AACjC,IAAM,gBAAgB,GAAG,OAAO,CAAC,qCAAqC,CAAC,CAAC,gBAAgB,CAAC;AACzF,IAAM,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AACjC,IAAM,MAAM,GAAG,OAAO,CAAC,WAAW,CAAC,CAAC;AACpC,IAAM,gBAAgB,gPAMkB,CAAC;AACzC,MAAM,CAAC,OAAO;AACV,aADmB,eAAe,OAC4B;YAAjD,SAAS,QAAT,SAAS;YAAE,SAAS,QAAT,SAAS;YAAE,UAAU,QAAV,UAAU;YAAE,YAAY,QAAZ,YAAY;;8BADxC,eAAe;;AAE9B,YAAI,CAAC,YAAY,GAAG,SAAS,CAAC;AAC9B,YAAI,YAAY,EAAE;AACd,gBAAM,yBAAyB,GAAG,YAAY,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;AAClE,kBAAM,CAAC,KAAK,CAAC,SAAS,GAAO,yBAAyB,yBAAuB,CAAC;AAC9E,kBAAM,CAAC,KAAK,CAAC,OAAO,GAAO,yBAAyB,YAAU,CAAC;AAC/D,kBAAM,CAAC,KAAK,CAAC,UAAU,GAAG,IAAI,CAAC;SAClC;AACD,YAAI,CAAC,MAAM,GAAG,IAAI,CAAC;AACnB,YAAI,CAAC,OAAO,GAAG,UAAU,IAAI,CAAC,CAAC;AAC/B,YAAI,CAAC,YAAY,GAAG,OAAO,CAAC,OAAO,EAAE,CAAC;AACtC,YAAI,CAAC,YAAY,GAAG,SAAS,CAAC;AAC9B,YAAM,IAAI,GAAG,SAAS,IAAI,gBAAgB,CAAC;AAC3C,YAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC;;;;AAAC,AAIzB,YAAM,OAAO,GAAG;AACZ,uBAAW,EAAE,yBAAyB;AACtC,kBAAM,EAAE,aAAa;AACrB,qBAAS,EAAE,gBAAgB;AAC3B,2BAAe,EAAE,sBAAsB;AACvC,mBAAO,EAAE,cAAc;SAC1B,CAAC;AACF,YAAI,CAAC,YAAY,GAAG,MAAM,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;AACzC,iBAAS,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;AAC3B,YAAI,CAAC,aAAa,GAAG,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;AAC/D,YAAI,CAAC,SAAS,EAAE,CAAC;KACpB;;iBA7BkB,eAAe;;qCAsCrB,GAAG,EAAE;;;;AAEd,gBAAI,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC;AACxC,qBAAS,eAAe,GAAG;AACvB,uBAAO,CAAC,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC;aAClC;;AAED,gBAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,oBAAoB,EAAE,eAAe,CAAC,CAAC;AAClG,mBAAO,KAAK,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAA,OAAO,EAAI;AAC1C,sBAAK,MAAM,GAAG,OAAO,CAAC;AACtB,uBAAO,MAAK,gBAAgB,CAAC,MAAK,OAAO,CAAC,CAAC;aAC9C,CAAC,CAAC,IAAI,CAAC,YAAM;AACV,sBAAK,YAAY,CAAC,mBAAmB,CAAC,MAAK,WAAW,CAAC,MAAM,CAAC,oBAAoB,EAAE,eAAe,CAAC,CAAC;aACxG,CAAC,CAAC;SACN;;;yCAEgB,OAAO,EAAE;;;AACtB,gBAAI,IAAI,CAAC,MAAM,IAAI,IAAI,EAAE;AACrB,uBAAO,IAAI,CAAC,YAAY,CAAC;aAC5B;AACD,gBAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,YAAM;AAC7C,uBAAO,OAAK,UAAU,CAAC,OAAO,CAAC,CAAC;aACnC,CAAC,CAAC;AACH,mBAAO,IAAI,CAAC,YAAY,CAAC;SAC5B;;;oCAEW;;;AACR,mBAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAK;AAC5B,oBAAM,aAAa,GAAG,OAAK,YAAY,CAAC,qBAAqB,EAAE,CAAC;AAChE,uBAAK,YAAY,CAAC,MAAM,CAAC,KAAK,GAAG,aAAa,CAAC,KAAK,CAAC;AACrD,uBAAK,YAAY,CAAC,MAAM,CAAC,MAAM,GAAG,aAAa,CAAC,MAAM,CAAC;AACvD,uBAAO,CAAC,aAAa,CAAC,CAAC;aAC1B,CAAC,CAAC,IAAI,CAAC,YAAM;AACV,uBAAO,OAAK,gBAAgB,CAAC,OAAK,OAAO,CAAC,CAAC;aAC9C,CAAC,CAAC;SACN;;;mCAEU;AACP,gBAAM,KAAK,GAAG,QAAQ,CAAC,WAAW,EAAE,CAAC;AACrC,gBAAM,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;AACvC,iBAAK,CAAC,kBAAkB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;AACjD,iBAAK,CAAC,cAAc,EAAE,CAAC;AACvB,iBAAK,CAAC,kBAAkB,CAAC,YAAY,CAAC,eAAe,CAAC,CAAC;AACvD,iBAAK,CAAC,cAAc,EAAE,CAAC;SAC1B;;;mCAEU,OAAO,EAAE;;;AAChB,gBAAM,WAAW,GAAG,IAAI,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,oBAAoB,EAAE,EAAC,MAAM,EAAE,IAAI,EAAC,CAAC,CAAC;AAClG,gBAAI,CAAC,YAAY,CAAC,aAAa,CAAC,WAAW,CAAC;;AAAC,AAE7C,mBAAO,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,UAAA,IAAI,EAAI;AAC7C,uBAAK,QAAQ,EAAE,CAAC;AAChB,oBAAM,YAAY,GAAG,OAAK,YAAY,CAAC;AACvC,oBAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,MAAM,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;AACzF,4BAAY,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,CAAC,MAAM,CAAC;AAC7C,4BAAY,CAAC,MAAM,CAAC,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;AAC3C,4BAAY,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,GAAG,YAAY,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC;AACrE,4BAAY,CAAC,SAAS,CAAC,KAAK,CAAC,MAAM,GAAG,YAAY,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM;;AAAC,AAEvE,oBAAM,aAAa,GAAG;AAClB,iCAAa,EAAE,OAAK,aAAa;AACjC,4BAAQ,EAAE,QAAQ;iBACrB,CAAC;AACF,oBAAM,aAAa,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,OAAO,CAAC;AACzD,oBAAM,gBAAgB,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,UAAA,WAAW,EAAI;AAC/D,wBAAM,gBAAgB,GAAG,IAAI,gBAAgB,CAAC;AAC1C,oCAAY,EAAE,YAAY,CAAC,SAAS;AACpC,gCAAQ,EAAE,QAAQ;AAClB,iCAAS,EAAE,CAAC;qBACf,CAAC,CAAC;AACH,oCAAgB,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;AAC7C,oCAAgB,CAAC,MAAM,EAAE,CAAC;iBAC7B,CAAC,CAAC;AACH,uBAAO,OAAO,CAAC,GAAG,CAAC,CACf,aAAa,EACb,gBAAgB,CACnB,CAAC,CAAC,IAAI,CAAC,UAAA,MAAM,EAAI;AACd,2BAAK,iBAAiB,CAAC,IAAI,EAAE,QAAQ,EAAE,YAAY,CAAC,eAAe,CAAC,CAAC;iBACxE,CAAC,CAAC;aACN,CAAC,CAAC,IAAI,CAAC,YAAM;AACV,uBAAK,eAAe,CAAC,OAAO,CAAC,CAAC;AAC9B,oBAAM,UAAU,GAAG,IAAI,WAAW,CAAC,OAAK,WAAW,CAAC,MAAM,CAAC,mBAAmB,EAAE,EAAC,MAAM,QAAM,EAAC,CAAC,CAAC;AAChG,uBAAK,YAAY,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;aAC/C,CAAC,CAAC;SACN;;;mCAEU;AACP,gBAAI,IAAI,CAAC,OAAO,IAAI,CAAC,EAAE;AACnB,uBAAO;aACV;AACD,gBAAI,CAAC,OAAO,EAAE,CAAC;AACf,mBAAO,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SAC9C;;;mCAEU;AACP,gBAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE;AACtC,uBAAO;aACV;AACD,gBAAI,CAAC,OAAO,EAAE,CAAC;AACf,mBAAO,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SAC9C;;;wCAEe,OAAO,EAAE;AACrB,gBAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC;AAClD,gBAAI,WAAW,KAAK,IAAI,EAAE;AACtB,oBAAM,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC;AACvC,oBAAI,QAAQ,GAAG,OAAO,GAAG,CAAC,CAAC;AAC3B,oBAAM,OAAO,GAAG,SAAS,KAAK,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,QAAQ,IAAI,SAAS,GAAG,CAAC,CAAA,AAAC,CAAC;AACzE,2BAAW,CAAC,KAAK,CAAC,KAAK,GAAO,OAAO,CAAC,QAAQ,EAAE,MAAI,CAAC;aACxD;SACJ;;;0CAEiB,IAAI,EAAE,QAAQ,EAAE,cAAc,EAAE;AAC9C,mBAAO,IAAI,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,UAAA,eAAe,EAAI;AACjD,oBAAM,SAAS,GAAG,QAAQ,CAAC,KAAK,CAAC,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC;AACnD,qBAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,eAAe,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAC7C,wBAAM,IAAI,GAAG,eAAe,CAAC,CAAC,CAAC,CAAC;AAChC,wBAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;AACxB,iCAAS;qBACZ;AACD,wBAAM,OAAO,GAAG,KAAK,CAAC,eAAe,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;AAC3D,wBAAI,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;AACrB,wBAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;AACvB,wBAAI,GAAG,KAAK,CAAC,IAAI,CAAC,aAAa,CAAC,CAC5B,IAAI,CAAC,CAAC,CAAC,EACP,IAAI,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,EAC3B,IAAI,CAAC,CAAC,CAAC,EACP,IAAI,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,CAC9B,CAAC,CAAC;AACH,2BAAO,CAAC,KAAK,CAAC,IAAI,GAAO,IAAI,CAAC,CAAC,CAAC,OAAK,CAAC;AACtC,2BAAO,CAAC,KAAK,CAAC,GAAG,GAAO,IAAI,CAAC,CAAC,CAAC,OAAK,CAAC;AACrC,2BAAO,CAAC,KAAK,CAAC,QAAQ,GAAG,UAAU,CAAC;AACpC,wBAAM,SAAS,GAAG,SAAS,CAAC,SAAS,CAAC;AACtC,wBAAM,YAAY,eAAc,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,MAAI,CAAC;AACxD,yBAAK,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,EAAE,OAAO,EAAE,YAAY,CAAC,CAAC;AAC9D,wBAAM,kBAAkB,GAAO,CAAC,IAAI,CAAC,CAAC,CAAC,WAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,OAAK,CAAC;AAC7D,yBAAK,CAAC,WAAW,CAAC,OAAO,CAAC,iBAAiB,EAAE,OAAO,EAAE,kBAAkB,CAAC,CAAC;AAC1E,wBAAI,IAAI,CAAC,OAAO,KAAK,MAAM,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;;;AAGtC,iCAAS;qBACZ;AACD,kCAAc,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;iBACvC;aACJ,CAAC,CAAC;SACN;;;4BAxJmB;AAChB,mBAAO;AACH,sCAAsB,EAAE,sBAAsB;AAC9C,qCAAqB,EAAE,qBAAqB;aAC/C,CAAC;SACL;;;WApCkB,eAAe;IAwLrC,CAAC","file":"PDFJSController.js","sourcesContent":["// LICENSE : MIT\n'use strict';\nglobal.PDFJS = global.PDFJS || {};\n//const stringToWorkerSrc = require(\"./string-to-worker-src\");\n//const workerCode = require(\"fs\").readFileSync(__dirname + '/../node_modules/pdfjs-dist/build/pdf.worker.js', \"utf-8\");\nrequire('pdfjs-dist/build/pdf.combined.js');\nrequire('pdfjs-dist/web/compatibility.js');\nrequire(\"custom-event-polyfill\");\nconst TextLayerBuilder = require('./pdf.js-contrib/text_layer_builder').TextLayerBuilder;\nconst domify = require('domify');\nconst domMap = require('./dom-map');\nconst defaultInnerHTML = `<div class=\"pdf-slide-progress\">\n    <div class=\"pdf-slide-progress-bar\"></div>\n</div>\n<div class=\"pdf-loading\"></div>\n<canvas class=\"pdf-canvas\"></canvas>\n<div class=\"pdf-textLayer\"></div>\n<div class=\"pdf-annotationLayer\"></div>`;\nmodule.exports = class PDFJSController {\n    constructor({container, innerHTML, pageNumber, pdfjsDistDir}) {\n        this.pdfContainer = container;\n        if (pdfjsDistDir) {\n            const pdfjsDistDirWithoutSuffix = pdfjsDistDir.replace(/\\/$/, '');\n            global.PDFJS.workerSrc = `${ pdfjsDistDirWithoutSuffix }/build/pdf.worker.js`;\n            global.PDFJS.cMapUrl = `${ pdfjsDistDirWithoutSuffix }/cmaps/`;\n            global.PDFJS.cMapPacked = true;\n        }\n        this.pdfDoc = null;\n        this.pageNum = pageNumber || 1;\n        this.promiseQueue = Promise.resolve();\n        this.pdfContainer = container;\n        const html = innerHTML || defaultInnerHTML;\n        const dom = domify(html);\n        /*\n         * @type {Object.<string, Node>}\n         */\n        const mapping = {\n            progressBar: '.pdf-slide-progress-bar',\n            canvas: '.pdf-canvas',\n            textLayer: '.pdf-textLayer',\n            annotationLayer: '.pdf-annotationLayer',\n            loading: '.pdf-loading'\n        };\n        this.domMapObject = domMap(dom, mapping);\n        container.appendChild(dom);\n        this.canvasContext = this.domMapObject.canvas.getContext('2d');\n        this.fitItSize();\n    }\n\n    static get Events() {\n        return {\n            'before_pdf_rendering': 'before-pdf-rendering',\n            'after_pdf_rendering': 'after_pdf_rendering'\n        };\n    }\n\n    loadDocument(url) {\n        // load complete\n        let loading = this.domMapObject.loading;\n        function hideLoadingIcon() {\n            loading.style.display = 'none';\n        }\n\n        this.pdfContainer.addEventListener(this.constructor.Events.before_pdf_rendering, hideLoadingIcon);\n        return PDFJS.getDocument(url).then(pdfDoc_ => {\n            this.pdfDoc = pdfDoc_;\n            return this._queueRenderPage(this.pageNum);\n        }).then(() => {\n            this.pdfContainer.removeEventListener(this.constructor.Events.before_pdf_rendering, hideLoadingIcon);\n        });\n    }\n\n    _queueRenderPage(pageNum) {\n        if (this.pdfDoc == null) {\n            return this.promiseQueue;\n        }\n        this.promiseQueue = this.promiseQueue.then(() => {\n            return this.renderPage(pageNum);\n        });\n        return this.promiseQueue;\n    }\n\n    fitItSize() {\n        return new Promise((resolve) => {\n            const containerRect = this.pdfContainer.getBoundingClientRect();\n            this.domMapObject.canvas.width = containerRect.width;\n            this.domMapObject.canvas.height = containerRect.height;\n            resolve(containerRect);\n        }).then(() => {\n            return this._queueRenderPage(this.pageNum);\n        });\n    }\n\n    _cleanup() {\n        const range = document.createRange();\n        const domMapObject = this.domMapObject;\n        range.selectNodeContents(domMapObject.textLayer);\n        range.deleteContents();\n        range.selectNodeContents(domMapObject.annotationLayer);\n        range.deleteContents();\n    }\n\n    renderPage(pageNum) {\n        const beforeEvent = new CustomEvent(this.constructor.Events.before_pdf_rendering, {detail: this});\n        this.pdfContainer.dispatchEvent(beforeEvent);\n        // Using promise to fetch the page\n        return this.pdfDoc.getPage(pageNum).then(page => {\n            this._cleanup();\n            const domMapObject = this.domMapObject;\n            const viewport = page.getViewport(domMapObject.canvas.width / page.getViewport(1).width);\n            domMapObject.canvas.height = viewport.height;\n            domMapObject.canvas.width = viewport.width;\n            domMapObject.textLayer.style.width = domMapObject.canvas.style.width;\n            domMapObject.textLayer.style.height = domMapObject.canvas.style.height;\n            // Render PDF page into canvas context\n            const renderContext = {\n                canvasContext: this.canvasContext,\n                viewport: viewport\n            };\n            const renderPromise = page.render(renderContext).promise;\n            const textLayerPromise = page.getTextContent().then(textContent => {\n                const textLayerBuilder = new TextLayerBuilder({\n                    textLayerDiv: domMapObject.textLayer,\n                    viewport: viewport,\n                    pageIndex: 0\n                });\n                textLayerBuilder.setTextContent(textContent);\n                textLayerBuilder.render();\n            });\n            return Promise.all([\n                renderPromise,\n                textLayerPromise\n            ]).then(result => {\n                this._setupAnnotations(page, viewport, domMapObject.annotationLayer);\n            });\n        }).then(() => {\n            this._updateProgress(pageNum);\n            const afterEvent = new CustomEvent(this.constructor.Events.after_pdf_rendering, {detail: this});\n            this.pdfContainer.dispatchEvent(afterEvent);\n        });\n    }\n\n    prevPage() {\n        if (this.pageNum <= 1) {\n            return;\n        }\n        this.pageNum--;\n        return this._queueRenderPage(this.pageNum);\n    }\n\n    nextPage() {\n        if (this.pageNum >= this.pdfDoc.numPages) {\n            return;\n        }\n        this.pageNum++;\n        return this._queueRenderPage(this.pageNum);\n    }\n\n    _updateProgress(pageNum) {\n        const progressBar = this.domMapObject.progressBar;\n        if (progressBar !== null) {\n            const numSlides = this.pdfDoc.numPages;\n            let position = pageNum - 1;\n            const percent = numSlides === 1 ? 100 : 100 * position / (numSlides - 1);\n            progressBar.style.width = `${ percent.toString() }%`;\n        }\n    }\n\n    _setupAnnotations(page, viewport, annotationArea) {\n        return page.getAnnotations().then(annotationsData => {\n            const cViewport = viewport.clone({dontFlip: true});\n            for (let i = 0; i < annotationsData.length; i++) {\n                const data = annotationsData[i];\n                if (!data || !data.hasHtml) {\n                    continue;\n                }\n                const element = PDFJS.AnnotationUtils.getHtmlElement(data);\n                let rect = data.rect;\n                const view = page.view;\n                rect = PDFJS.Util.normalizeRect([\n                    rect[0],\n                    view[3] - rect[1] + view[1],\n                    rect[2],\n                    view[3] - rect[3] + view[1]\n                ]);\n                element.style.left = `${ rect[0] }px`;\n                element.style.top = `${ rect[1] }px`;\n                element.style.position = 'absolute';\n                const transform = cViewport.transform;\n                const transformStr = `matrix(${ transform.join(',') })`;\n                PDFJS.CustomStyle.setProp('transform', element, transformStr);\n                const transformOriginStr = `${ -rect[0] }px ${ -rect[1] }px`;\n                PDFJS.CustomStyle.setProp('transformOrigin', element, transformOriginStr);\n                if (data.subtype === 'Link' && !data.url) {\n                    // In this example,  we do not handle the `Link` annotation without url.\n                    // If you want to handle these links, see `web/page_view.js`.\n                    continue;\n                }\n                annotationArea.appendChild(element);\n            }\n        });\n    }\n};"]}